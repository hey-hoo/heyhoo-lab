name: Claude Actions

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-response:
    if: contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Extract Claude request
      id: extract
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          BODY="${{ github.event.issue.body }}"
        else
          BODY="${{ github.event.comment.body }}"
        fi
        
        # @claudeã®å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        REQUEST=$(echo "$BODY" | grep -o '@claude.*' | sed 's/@claude//' | xargs)
        echo "request=$REQUEST" >> $GITHUB_OUTPUT
        echo "Request: $REQUEST"
        
    - name: Call Claude API
      id: claude
      run: |
        RESPONSE=$(curl -X POST https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d '{
            "model": "claude-3-sonnet-20240229",
            "max_tokens": 1000,
            "messages": [
              {
                "role": "user", 
                "content": "ãƒ˜ãƒ¼ãƒ›ãƒ¼å­¦èˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${{ steps.extract.outputs.request }}"
              }
            ]
          }')
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰contentã‚’æŠ½å‡º
        CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create or update content
      run: |
        CONTENT="${{ steps.claude.outputs.content }}"
        REQUEST="${{ steps.extract.outputs.request }}"
        
        # FAQãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆ
        if echo "$REQUEST" | grep -i "faq"; then
          echo "---" > faq.md
          echo "layout: page" >> faq.md
          echo "title: FAQ" >> faq.md
          echo "permalink: /faq/" >> faq.md
          echo "---" >> faq.md
          echo "" >> faq.md
          echo "$CONTENT" >> faq.md
        
        # è¬›åº§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆ  
        elif echo "$REQUEST" | grep -i "è¬›åº§\|course"; then
          echo "---" > courses.md
          echo "layout: page" >> courses.md
          echo "title: è¬›åº§" >> courses.md
          echo "permalink: /courses/" >> courses.md
          echo "---" >> faq.md
          echo "" >> courses.md
          echo "$CONTENT" >> courses.md
          
        # ãã®ä»–ã®å ´åˆã¯æ–°ã—ã„æŠ•ç¨¿ã¨ã—ã¦ä½œæˆ
        else
          DATE=$(date +%Y-%m-%d)
          FILENAME="_posts/$DATE-claude-response.md"
          echo "---" > "$FILENAME"
          echo "layout: post" >> "$FILENAME"
          echo "title: Claude Response" >> "$FILENAME"
          echo "date: $DATE" >> "$FILENAME"
          echo "---" >> "$FILENAME"
          echo "" >> "$FILENAME"
          echo "$CONTENT" >> "$FILENAME"
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Claude Actions"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Claude update: ${{ steps.extract.outputs.request }}"
          git push
        fi
        
    - name: Comment on issue
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸ¤– ClaudeãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼\n\n**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ${{ steps.extract.outputs.request }}\n\n**å†…å®¹**: \n${{ steps.claude.outputs.content }}\n\nå¤‰æ›´ãŒã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã‚‹ã¾ã§æ•°åˆ†ãŠå¾…ã¡ãã ã•ã„ã€‚'
          })

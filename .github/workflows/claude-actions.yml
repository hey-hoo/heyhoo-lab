name: Simple Claude Actions

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-response:
    if: contains(github.event.issue.title, '@claude') || contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean files
      run: |
        rm -rf _posts posts
        rm -f faq.md courses.md about.md blog-*.md
        
    - name: Get request
      id: req
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          # IssueÊú¨Êñá„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
          echo '${{ github.event.issue.body }}' > request.txt
        else
          echo '${{ github.event.comment.body }}' > request.txt
        fi
        echo "file=request.txt" >> $GITHUB_OUTPUT
        
    - name: Call Claude
      run: |
        REQUEST_FILE="${{ steps.req.outputs.file }}"
        REQUEST_CONTENT=$(cat "$REQUEST_FILE")
        
        curl -s -X POST https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d "{
            \"model\": \"claude-3-sonnet-20240229\",
            \"max_tokens\": 2000,
            \"messages\": [{
              \"role\": \"user\", 
              \"content\": \"‰ª•‰∏ã„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅ„Éò„Éº„Éõ„ÉºÂ≠¶Ëàé„ÅÆWeb„Çµ„Ç§„ÉàÁî®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥ÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\\n\\n$REQUEST_CONTENT\"
            }]
          }" | jq -r '.content[0].text // "„Ç®„É©„Éº"' > content.txt
        
    - name: Update index
      run: |
        echo "---" > index.md
        echo "layout: home" >> index.md
        echo "---" >> index.md
        echo "" >> index.md
        cat content.txt >> index.md
        
    - name: Commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Claude Actions"
        git add .
        git commit -m "Update by Claude" || echo "No changes"
        git push
        
    - name: Comment
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d '{"body":"ü§ñ Êõ¥Êñ∞ÂÆå‰∫ÜÔºÅ"}'

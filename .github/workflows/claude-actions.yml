name: Claude Actions

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-response:
    if: contains(github.event.issue.title, '@claude') || contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: main
        
    - name: Setup directories
      run: |
        # æ—¢å­˜ã®_postsãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -rf _posts
        # _postsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ–°è¦ä½œæˆ
        mkdir _posts
        touch _posts/.gitkeep
        echo "Created _posts directory"
        
    - name: Extract request
      id: request
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          TEXT="${{ github.event.issue.title }} ${{ github.event.issue.body }}"
        else
          TEXT="${{ github.event.comment.body }}"
        fi
        REQUEST=$(echo "$TEXT" | sed 's/.*@claude *//g' | head -1)
        echo "text=$REQUEST" >> $GITHUB_OUTPUT
        echo "Request: $REQUEST"
        
    - name: Call Claude API
      id: claude
      run: |
        REQUEST="${{ steps.request.outputs.text }}"
        echo "Calling Claude with: $REQUEST"
        
        RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d "{
            \"model\": \"claude-3-sonnet-20240229\",
            \"max_tokens\": 1000,
            \"messages\": [{
              \"role\": \"user\", 
              \"content\": \"ãƒ˜ãƒ¼ãƒ›ãƒ¼å­¦èˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ: $REQUEST\"
            }]
          }")
        
        CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text // "ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
        echo "Generated content: $CONTENT"
        
        {
          echo "content<<ENDOFCONTENT"
          echo "$CONTENT"
          echo "ENDOFCONTENT"
        } >> $GITHUB_OUTPUT
        
    - name: Update content
      run: |
        CONTENT="${{ steps.claude.outputs.content }}"
        REQUEST="${{ steps.request.outputs.text }}"
        
        if echo "$REQUEST" | grep -qi "faq"; then
          FILE="faq.md"
          TITLE="FAQ"
          PERMALINK="/faq/"
          echo "---" > "$FILE"
          echo "layout: page" >> "$FILE"
          echo "title: $TITLE" >> "$FILE"
          echo "permalink: $PERMALINK" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          
        elif echo "$REQUEST" | grep -qi "è¬›åº§"; then
          FILE="courses.md"
          TITLE="è¬›åº§"
          PERMALINK="/courses/"
          echo "---" > "$FILE"
          echo "layout: page" >> "$FILE"
          echo "title: $TITLE" >> "$FILE"
          echo "permalink: $PERMALINK" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          
        elif echo "$REQUEST" | grep -qi "ãƒˆãƒƒãƒ—\|index\|ãƒ›ãƒ¼ãƒ "; then
          FILE="index.md"
          echo "---" > "$FILE"
          echo "layout: home" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          
        else
          FILE="about.md"
          TITLE="About"
          PERMALINK="/about/"
          echo "---" > "$FILE"
          echo "layout: page" >> "$FILE"
          echo "title: $TITLE" >> "$FILE"
          echo "permalink: $PERMALINK" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
        fi
        
        echo "Updated: $FILE"
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Claude Actions"
        git pull origin main
        git add .
        git commit -m "Update content via Claude" || echo "No changes"
        git push origin main
        
    - name: Comment
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d '{"body":"ğŸ¤– ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼æ•°åˆ†å¾Œã«ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚"}'
